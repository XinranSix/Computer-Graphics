# 着色（Shading）

> 在 GAMES101 这门课中，认为着色是将一个材质应用到一个物体上。

## Blinn-Phong 反射模型（Blinn-Phong Reflectance Model）

Blinn-Phong 反射模型是一个简单的着色模型，这个模型考虑了以下几个部分：漫反射（Diffuse reflection），高光（Specular highlights），环境光（Ambient lighting）。

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230043719-b38a5f9a-4dad-4dfb-99ec-e604b0566325.png" alt="Img" style="zoom:100%;" />
</center>

### 模型定义

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230045266-484d6e6c-e83f-4c4b-9282-93b68c6dfc80.png" alt="光线反射模型" style="zoom:100%;" />
</center>

对于任意的着色点（Shading poing），我们定义：

- 观察方向（Viewer direction）$\vec{v}$，是着色点到观察点的连线；

- 法线（Surface normal）$\vec{n}$，是垂直于反射面的方向向量；
- 光照方向（Light direction）$\vec{l}$，是着色点和光源的连线。

向量 $\vec{v}$、$\vec{n}$、$\vec{l}$ 都是单位向量。同时我们还需要定义物体表面的参数，例如颜色，亮度。

着色是局部的操作，着色时，不考虑其他的物体遮挡，因此着色中没有阴影。

### 漫反射（Diffuse Reflection）

漫反射中光会向各个方向均匀反射，从如何方向观察到的表面颜色多是相同的。

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230047344-9a171c3d-f50c-4bf2-8726-1d499ed1bb5a.png" alt="漫反射示意图" style="zoom:75%;" />
</center>
**Lambert’s 余弦定律**（Lambert’s Cosine Law）表明了漫反射光的能量和入射角度之间的关系。光线反射的能量和光照方向（$\vec{l}$）以及法线（$(vec{n})$）的夹角余弦值（即 $\cos \theta$）成正比。

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230047998-59946ccc-229d-419a-9de3-d6e126ed8e3d.png" alt="Lambert’s 余弦定律" style="zoom:75%;" />
</center>

由于 $\vec{l}$ 和 $\vec{n}$ 都是单位向量，所以可以得到：
$$
\cos \theta = \vec{l} \cdot \vec{n}
$$
对于一个点光源，在同一时刻的光的能量集中在一个球壳上，考虑到能量守恒定律，每个时刻球壳上的能量总和不变。随着球壳的变大，单位面积上的光能量会变小。设距离为 $1$ 时的能量为 $I$，则在距离为 $r$ 的地方光的能量为：
$$
\frac{I}{r^2}
$$
经过上述分析，得出的漫反射公式为：
$$
L_d = k_d \frac{I}{r^2} \max \left(0,\boldsymbol{n} \cdot \boldsymbol{l}\right)
$$

上述公式中，$k_d$ 表示漫反射系数，如果用 RGB 定义一个向量作为漫反射系数就可以代表这个反射点的颜色。$\max \left(0,\boldsymbol{n} \cdot \boldsymbol{l}\right)$ 可以把反射光线在反方向的光线过滤掉，这些光线没有任何贡献。从公式可以看出，漫反射与观测方向没有任何关系，符合漫反射的定义。

下图表述了不同的 $k_d$ 下的漫反射效果：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230051381-ebf6114d-6390-4c87-8473-0fd2cc02eaa6.png" alt="Lambert’s 余弦定律" style="zoom:75%;" />
</center>

### 高光项（镜面反射）

镜面反射取决于观察方向，当观察方向与反射方向接近时我们就能看到高光，如下图所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230074681-e0497c4d-4714-47f7-8bb4-0b163621ce2d.png" alt="镜面反射示意图" style="zoom:75%;" />
</center>

在实际应用中一般用**半程向量**（Half vector）来刻画观察方向和反射方向的解决程度。如果观察方向和反射方向非常接近，则半程向量和法线方向非常接近，如下图所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230075798-ab5f2a87-53c2-4c1e-9e68-47333026d731.png" alt="半程向量示意图" style="zoom:75%;" />
</center>

半程向量用 $\vec{h}$ 表示，$\vec{h}$ 也是单位向量，显然：
$$
\vec{h} = \frac{\vec{n} + \vec{l}} {\left\|\vec{v} + \vec{l}\right\|}
$$
高光项计算公式为：
$$
\begin{align*}
L_s &= k_s \frac{I} {r^2} \max\left(0, \cos \alpha \right)^p \\ 
& = k_s \frac{I} {r^2} \max\left(0, \vec{n} \cdot \vec{h} \right)
\end{align*}
$$

公式中 $k_s$ 为镜面反射系数。Blinn-Phong 反射模型中的高光项不考虑 Lambert’s 余弦定律，即忽略 $\left(0,\boldsymbol{n} \cdot \boldsymbol{l}\right)$. 在公式中，有一个指数 $p$，引入这个指数是为了将高光限制在一个小范围内，一般来说：$p\in\left[100, 200\right]$。不同的 $p$ 对余弦函数的影响如下：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230078747-e9a54e57-216f-4d57-936a-ad05c887f497.png" alt="指数的选择" style="zoom:75%;" />
</center>

选取不同的 $p$ 和 $k_s$ 的得到的效果如下图所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230079173-753ff962-9657-422f-8842-0bdc36f76b7c.png" alt="Img" style="zoom:100%;" />
</center>

### 环境光

在 Blinn-Phong 反射模型中认为环境光是一个常数，不依赖于光源方向、法线方向和观察方向。环境光计算公式如下：
$$
L_a = k_a I_a
$$
其中 $I_a$ 为环境光反射系数。

### Blinn-Phong 反射模型

综上所述，Blinn-Phong 反射模型如下：
$$
\begin{align*}
L &= L_a + L_d + L_S \\
&= k_aI_a + k_d \frac{I}{r^2} \max\left(0, \vec{n} \cdot \vec{l}\right) + k_s \frac{I}{r^2} \max\left(0, \vec{n} \cdot \vec{h}\right)^p
\end{align*}
$$

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230080150-2dd31032-835b-4844-8dc5-70479b002326.png" alt="Blinn-Phong 反射模型" style="zoom:100%;" />
</center>

## 着色频率（Shading Frequencies）

根据不同的着色方式，有不同的着色频率，主要的着色频率分为三种——面着色、顶点着色和像素着色。主要的不同之处在于法线的选择方式不同。

- **面着色**（Flat Shading，指的是计算每一个三角形平面的法线后对一个平面整体进行着色；
- **顶点着色**（Gouraud Shading），指的是计算每一个三角形三个顶点的法线后进行着色，最后在三角形内部插值得到颜色。顶点法线的计算是通过顶点相邻面的法线的（加权）平均值求出；
- **像素着色**（Phong Shading），指的是计算出每一个像素的法线进行着色。三角形内部点法线的计算需要依靠重心坐标进行插值计算。

不同的着色频率的效果如下所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230081961-97fcfe87-65e7-4450-96a8-23612143e532.png" alt="Img" style="zoom:100%;" />
</center>

当几何体相对复杂，构造精细的时候，三种着色效果产生的结果不相上下，如下图所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230082185-4a581a7f-93ef-4136-8d25-7f3e61e3d0a2.png" alt="Img" style="zoom:75%;" />
</center>

如何定义一个顶点的法线呢？有两种方法，一种是使用一个球形包围盒，求顶点法线就简化成了求球表面顶点的法线，如下如所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230083024-b99a0202-a6bc-4e13-9371-e2dd89781bf3.png" alt="Img" style="zoom:50%;" />
</center>

另外一种方法是求出顶点相邻的三角形的法线，然后做一个平均，再做一个归一化，即：
$$
N_v = \frac{\sum_i N_i}{\left\| \sum_i N_i \right\|}
$$

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230083668-cfcc2ce1-73d5-4def-9f84-c3e252a22245.png" alt="Img" style="zoom:50%;" />
</center>

如何求出每个像素的法线呢？先求出三角形顶点的法线，在通过插值的方式求出每个像素的法线，如下图所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230084990-758e0bc0-c1b8-40d4-9103-188f54e45e52.png" alt="Img" style="zoom:75%;" />
</center>

## 实时渲染管线（Real-time Rendering Pipeline）

管线是从模型到图片生成的过程。管线分为以下过程：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230085432-ae7b5ff2-172f-4fea-8e71-0c57e43eb60e.png" alt="管线" style="zoom:100%;" />
</center>

首先将顶点的三位向量作为输入，进行几何变换后划分三角形区域。通过光栅化获得一个个小的碎片（或者是一个个小像素）后进行着色，得到我们的输出。

我们可以定义顶点或者像素的着色方式来提供不同的着色要求，这被称为程序 Shader。硬件中会提供这样的编程方式定制不同的着色方式，以 OpenGL 为例，可以定义以下的着色函数：

```glsl
uniform sampler2D myTexture;
uniform vec3 lightDir;
varying vec2 uv;
varying vec3 norm;

void diffuseShader() {
    vec3 kd;
    kd = texture2d(myTexture, uv);
    kd *= clamp(dot(-lightDir, norm), 0.0, 1.0);
    gl_FragColor = (kd, 1.0);
}
```

这里我们定义了一个简单的漫反射着色器。同时，着色器会自动应用到每一个顶点或者是像素上，不需要我们使用显式的 for 循环进行遍历。

> 我们可以进入 [Shadertoy](https://www.shadertoy.com/view/ld3Gz2) 网站练习 Shader 编程，编程的结果会直接显示在网页中。
>
> 关于管线的更多内容可以参考文章：《细说图形学渲染管线》。
