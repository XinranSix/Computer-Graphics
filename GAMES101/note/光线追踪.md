# 光线追踪（Ray Tracing）

光线追踪可以解决解决光栅化中没有解决的一些问题：

- 全局的光照效果不好表示；

- 软阴影效果的产生；
- 光泽反射（Glossy reflection）；
- 间接光照，在漫反射场景中，有些光线在到达眼睛前反射不止一次。

光栅化是一种快速、近似的一种渲染方式，用于实时渲染；光线追踪是比较准确但是比较慢的渲染方式，用于离线渲染。

## 基本光线追踪方法

我们假设光线满足下面 3 点要求：

1. 光线沿直线传播；
2. 光线与光线直接「无碰撞」；
3. 光线从光源射入人眼中，但在路径反转的情况下，物理性质是不变的（光路的可逆性）。

光的可逆性是光线追踪的重要思想（尽管它不符合实际物理学）。

- 通过每像素投射一条光线生成图像
- 通过向灯光发送光线来检查阴影

视眼睛（相机）为一个点，光源为点光源。对于每一个像素，我们从眼睛向像素画出一条光线，如果光线和物体有交点（这个交点要求是光线上的第一个交点，因为后面的交点都会被第一个交点遮挡），将这个交点和光源进行连线，如果可以连接到光源（即连线上无遮挡），那么这一点会被光源照亮，在这一点上要计算着色。

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230715952-5e2915dd-a5ba-49c2-9e5c-55afb864f46c.png" alt="Img" style="zoom:75%;" />
</center>

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230715967-91f702bd-2922-4d54-afad-2576002b432c.png" alt="Img" style="zoom:75%;" />
</center>

## Whitted-Style 光线追踪

从眼睛沿着像素连接一条光线，我们认为光线在传播过程中会发生反射和折射，且假设反射是完美的镜面反射。将所有反射、折射点和光源连接起来，如果可以连接，则这一点会被光源照亮，那么这一点的着色要叠加到这个像素上。对于一个像素，可能对应多个被照亮的点，**需要将这些点的着色全部叠加到这个像素上**。

我们认为光线在传播的过程中发生反射和折射现象。假设反射是完美的镜面反射。当我们将所有的反射（折射）点和光源连接起来。如果这一点可以被光源照亮，那么我们认为这一点的着色应当叠加在这个像素上。对于光线我们认为存在能量的消逝，不会一直反射。

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230716051-fbd5333c-44fb-462d-9c4f-7b0f6c4f8ebd.png" alt="Img" style="zoom:75%;" />
</center>

在上图中，通过了像素但还没通过反射、折射点的光线称为 primary ray，经过了反射、折射点的光线称为 secondary rays，从反射、折射点连接到光源的光线称为 shadow rays.

我们需要求出光线与物体表面的交点，才能确定反射点和折射点。

## 光线-表面求交

### 光线方程

光线方程通过其光源实在的位置和一个方向向量定义，如下所示：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230716370-e32022af-4b56-4d12-ab60-3c55cbc956d5.png" alt="Img" style="zoom:100%;" />
</center>

光线方程为：
$$
\mathbf{r}\left(t\right)=\mathbf{o}+t \mathbf{d} \quad 0 \leq t<\infty
$$

### 光线与隐式表面求交

先来看光线如何和球面求交，已知光线方程为：
$$
\mathbf{r}\left(t\right) = \mathbf{o} + t\mathbf{d} \quad 0 \leq t<\infty
$$
球面方程为：
$$
\mathbf{p}: \left(\mathbf{p - c}\right)^2 - R^2 = 0
$$


那么光线和球面的交点满足：
$$
\left(\mathbf{o} + t\mathbf{d} - \mathbf{c}\right)^2 - R^2 = 0
$$
这是一个二次方程，可以写为：
$$
\begin{align*}
&at^2 + bt^2 + c = 0 \\
&a = \mathbf{d} \cdot \mathbf{d}\\
&b =  2 \left(\mathbf{o} - \mathbf{c}\right) \cdot \mathbf{d}\\
&c = \left(\mathbf{o}-\mathbf{c}\right) \cdot \left(\mathbf{o}-\mathbf{c}\right) - R^2
\end{align*}
$$
这个方程的解为：
$$
t = \frac{-b \pm \sqrt{b^2 -4ac}}{2a}
$$
解出的 $t$ 为正实数是光线与圆就有交点。

对于一般的隐式表面，其方程为：
$$
\mathbf{p} : f\left(\mathbf{b}\right) = 0
$$
带入光线方程的：
$$
f\left(\mathbf{o} + t\mathbf{d}\right) = 0
$$
只要求解出的 $t$ 为正实数，则光线与表面有交点。

### 光线与显示三角形面求交

> 对于一个封闭的曲面，我们可以通过求光线与曲面的交点的个数来判断光源实在这个曲面的内部还是内部。如果光线与曲面的交点个数为奇数，则光源在曲面内部；如果光线与曲面的交点个数为偶数，则光源在曲面外部。

三角形一点处于一个平面上，光线与三角形求交分为两步：

1. 求出光线与三角形所在平面的交点；
2. 判断这个交点是否在三角形内部。

对于一个平面，我们可以使用平面的法向量和平面上的一点来表示这个平面的方程：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230717077-4c6a3992-0878-4892-a924-716d670140f3.png" alt="Img" style="zoom:100%;" />
</center>

假设平面的法向量为 $\mathbf{N}$，平面上的一点为 $\mathbf{p'}$，这平面方程为：
$$
\mathbf{p}: \left(\mathbf{p} - \mathbf{p}'\right) \cdot \mathbf{N} = 0
$$
将光线方程带入平面方程得：
$$
\left(\mathbf{o} + t \mathbf{d} - \mathbf{p}\right)\cdot \mathbf{N} = 0
$$
解得：
$$
t = \frac{\left(\mathbf{p}' - \mathbf{o}\right) \cdot \mathbf{N}}{\mathbf{d} \cdot \mathbf{N}}
$$
然后检查 $t$ 是否为正实数。

### Möller Trumbore 算法

对于 $\triangle P_0P_1P_2$，在三角形平面上的点满足：

$$
\mathbf{P} = (1 - b_1 - b_2) \mathbf{P_0} + b_1\mathbf{P_1} + b_2\mathbf{P_2}
$$

求交点得：

$$
\mathbf{O} + t\mathbf{D} = (1 - b_1 - b_2) \mathbf{P_0} + b_1\mathbf{P_1} + b_2\mathbf{P_2}
$$

解得：

$$
\begin{bmatrix}
t \\
b_1\\
b_2
\end{bmatrix} = \frac{1}{\mathbf{S_1} \cdot \mathbf{S_2}}\begin{bmatrix}
\mathbf{S_2} \cdot \mathbf{E_2} \\
\mathbf{S_1} \cdot \mathbf{S} \\
\mathbf{S_2} \cdot \mathbf{D}
\end{bmatrix}
$$

其中：
$$
\begin{align*}
\mathbf{E_1} &= \mathbf{P_1} - \mathbf{P_0} \\
\mathbf{E_2} &= \mathbf{P_2} - \mathbf{P_0} \\
\mathbf{S} &= \mathbf{O} - \mathbf{P_0} \\
\mathbf{S_1} &= \mathbf{D} \times \mathbf{E_2} \\
\mathbf{S_2} &= \mathbf{S} \times \mathbf{E_1} 
\end{align*}
$$
最后检查 $b1 \ge 0$、$b2 \ge 0$、$1 - b_1 - b_2 \ge 0$ 是否成立，成立则说明解是合理的。

## 光线-表面求交加速

简单的光线表面求交算法每一像素需要对每一个三角形都进行测试，然后找出深度最小的那个点，这个算法需要计算  $\text{\#pixels} \times \text{\#traingles}$ 次，是非常满的。

### 包围盒（Bounding Volumes）

将物体使用一个简单的包围盒包起来，如果光线与包围盒都没有交点，则一定与这个物体表面没有交点，所以我们可以先测试包围盒，如果光线与包围盒有交点，再测试物体。

我们常用的包围盒是**轴对齐包围盒**（Axis-Aligned Bounding Box, AABB），包围盒的长宽高和坐标轴都是平行的。我们认为包围盒是 3 对无限大的平面。

先来看一下 2 维情况下光线与包围盒的求交：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230718152-4ac85887-f9e4-412e-8483-a33a306884b4.png" alt="Img" style="zoom:100%;" />
</center>

我们求出光线在 x 平面上的两个交点以及 y 平面上的两个交点，那么最终光线在包围盒内部的部分是这些交点区间的交集。

可以认为：

- 光线进入到三个面中，才可以进入到包围盒；
- 光线离开任意一个面，就会离开包围盒。

在 3 维的情况下，我们对每对平面求一个 $t_{\text{min}}$ 和 $t_{\text{max}}$，然后令 $t_{\text{enter}} = \max{\left\{t_{\text{min}}\right\}}$，$t_{\text{exit}} = \min{\left\{t_{\text{max}}\right\}}$.

如果 $t_{\text{exit}} \lt 0$，则包围盒在光源的「背面」；如果 $t_{\text{exit}} \ge 0$ 且 $t_\text{enter} \lt 0$，则光源在包围内。

综上所述，当 $t_\text{enter} < t_\text{exit}$ 且 $t_\text{exit} \gt 0$ 时，光源和包围盒有交点。

使用轴对齐包围盒可以非常快速地计算出 $t$，例如对于垂直于 $x$ 轴的平面：

<center>
    <img src="https://user-images.githubusercontent.com/62458905/230718698-d6ea213d-a9ef-4c4b-9be9-403504b70eb6.png" alt="Img" style="zoom:100%;" />
</center>

$t$ 求出来为：
$$
t = \frac{\mathbf{p}'_x - \mathbf{o}_x}{\mathbf{d}_x}
$$
