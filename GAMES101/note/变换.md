# 变换（Transformation）

## 二维变换（2D Transformations）

### 伸缩变换（Scale Transform）

![image-20230228193346056](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228193346056.png)

$$
\begin{aligned}
x^{\prime} & =s x \\
y^{\prime} & =s y
\end{aligned}
$$

变换矩阵为：

$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{ll}
s & 0 \\
0 & s
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$

对于一般的伸缩变换来说：

![image-20230228193521251](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228193521251.png)

$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{cc}
s_x & 0 \\
0 & s_y
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$

### 反射变换（Reflection Transform）

![image-20230228193632022](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228193632022.png)

对于**水平方向的反射（Horizontal reflection）**有：

$$
\begin{aligned}
& x^{\prime}=-x \\
& y^{\prime}=y
\end{aligned}
$$

变换矩阵为：

$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{cc}
-1 & 0 \\
0 & 1
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$

显然对与垂直方向的反射来说，其变换矩阵为：
$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{cc}
1 & 0 \\
0 & -1
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$


### 错切变换（Shear Transform）

![image-20230228193840206](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228193840206.png)

考虑水平方向的错切：

-   对于 $y = 0$ 上的点来说，其**水平移位（Horizontal shift**）为 0.
-   对于 $y = 1$ 上的点来说，其**水平移位（Horizontal shift**）为 a.
-   **垂直移位（Vertical shift ）**始终为 0.

变换矩阵为：

$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{ll}
1 & a \\
0 & 1
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$

显然垂直方向的错切变换，其变换矩阵为：
$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{ll}
1 & 0 \\
b & 1
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$


### 旋转变换（Rotate Transform）

默认情况下，都是考虑绕点 $(0, 0)$ ，**逆时针（CCW）**旋转。旋转矩阵的推导如下：

![image-20230228195155887](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228195155887.png)

即旋转变换的变换矩阵为：

$$
\mathbf{R}_\theta=\left[\begin{array}{cc}
\cos \theta & -\sin \theta \\
\sin \theta & \cos \theta
\end{array}\right]
$$

### 线性变换（Linear Transformations）

线性变换 = 变换矩阵的维度相同（变换矩阵的形状一样）。线性变换可以像下面这样表示。
$$
\begin{aligned}
x^{\prime} & =a x+b y \\
y^{\prime} & =c x+d y
\end{aligned}
$$

$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{ll}
a & b \\
c & d
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]
$$

显然，伸缩变换，反射变换，错切变换和旋转变换都是线性变换。

## 齐次坐标（Homogeneous Coordinates）

### 平移变换（Translation Transform）

![image-20230228203916533](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228203916533.png)
$$
\begin{aligned}
x^{\prime} & =x+t_x \\
y^{\prime} & =y+t_y
\end{aligned}
$$

考虑平移变换，得到的变换矩阵为：
$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{ll}
a & b \\
c & d
\end{array}\right]\left[\begin{array}{l}
x \\
y
\end{array}\right]+\left[\begin{array}{l}
t_x \\
t_y
\end{array}\right]
$$

可以看出，平移变换不是线性变换。

### 齐次坐标（Homogenous Coordinates）

齐次坐标就是在原来的坐标上加上一个**维度（w-coordinate）**：

- 2D point = $\left[\begin{array}{l}x & y & 1 \\  \end{array}\right]^{T}$.
- 2D vector = $\left[\begin{array}{l}x & y & 0 \\  \end{array}\right]^{T}$.

用其次坐标表示平移变换：
$$
\left[\begin{array}{cccc}
x^{\prime} \\
y^{\prime} \\
w^{\prime}
\end{array}\right]=\left[\begin{array}{cccc}
1 & 0 & t_x \\
0 & 1 & t_y \\
0 & 0 & 1
\end{array}\right]\left[\begin{array}{cccc}
x \\
y \\
1
\end{array}\right]=\left[\begin{array}{cccc}
x+t_x \\
y+t_y \\
1
\end{array}\right]
$$

当求出来的 w-coordinate 为 1 或者 0 时才是一个有效的操作：

- vector + vector = vector
- point – point = vector
- point - vector = point
- point - point = midpoint

在齐次坐标中，$\left[\begin{array}{l}x \\y \\w \end{array}\right]$ 表示二维空间中的点： $\left[\begin{array}{cccc} \frac{x}{w} \\ \frac{y}{w} \\1 \end{array}\right]$, $w \neq 0$.

### 仿射变换（Affine Transformations）

仿射变换 = 线性变换 + 平移变换。
$$
\left[\begin{array}{cccc}
x^{\prime} \\
y^{\prime}
\end{array}\right]=\left[\begin{array}{cccc}
a & b \\
c & d
\end{array}\right]\left[\begin{array}{cccc}
x \\
y
\end{array}\right]+\left[\begin{array}{cccc}
t_x \\
t_y
\end{array}\right]
$$
其次坐标表示如下：
$$
\left[\begin{array}{cccc}
x^{\prime} \\
y^{\prime} \\
1
\end{array}\right]=\left[\begin{array}{cccc}
a & b & t_x \\
c & d & t_y \\
0 & 0 & 1
\end{array}\right] \left[\begin{array}{cccc}
x \\
y \\
1
\end{array}\right]
$$

### 二维空变换的其次坐标表示（2D Transformations In Homogeneous Coordinates）

错切变换：

$$
\mathbf{S}\left(s_x, s_y\right)=\left[\begin{array}{ccc}
s_x & 0 & 0 \\
0 & s_y & 0 \\
0 & 0 & 1
\end{array}\right]
$$

旋转变换：

$$
\mathbf{R}(\alpha)=\left[\begin{array}{ccc}
\cos \alpha & -\sin \alpha & 0 \\
\sin \alpha & \cos \alpha & 0 \\
0 & 0 & 1
\end{array}\right]
$$

平移变换：

$$
\mathbf{T}\left(t_x, t_y\right)=\left[\begin{array}{ccc}
1 & 0 & t_x \\
0 & 1 & t_y \\
0 & 0 & 1
\end{array}\right]
$$

### 拟变换（Inverse Transform）

设 $M$，为一个变换矩阵，对于 $M$ 来说，${M}^{-1}$ 为其在代数和几何上的逆变换。

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228210007049.png" alt="image-20230228210007049" style="zoom:50%;" />

### 复合变换（Composing Transforms）

请注意下面两个变换中的变换顺序：

![image-20230228210810706](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228210810706.png)

矩阵乘法不可交换，也就是说，变换顺序很重要。

$$
R_{45} \cdot T_{(1,0)} \neq T_{(1,0)} \cdot R_{45}
$$

注意矩阵重从右到左依次应用
$$
T_{(1,0)} \cdot R_{45}\left[\begin{array}{l}
x \\
y \\
1
\end{array}\right]=\left[\begin{array}{lll}
1 & 0 & 1 \\
0 & 1 & 0 \\
0 & 0 & 1
\end{array}\right]\left[\begin{array}{ccc}
\cos 45^{\circ} & -\sin 45^{\circ} & 0 \\
\sin 45^{\circ} & \cos 45^{\circ} & 0 \\
0 & 0 & 1
\end{array}\right]\left[\begin{array}{l}
x \\
y \\
1
\end{array}\right]
$$

#### 复合变换（Composing Transforms）

有一个仿射变换序列：$A_{1}, A_{2}, A_{3}, \dots$ 
$$
A_n\left(\ldots A_2\left(A_1(\mathbf{x})\right)\right)=\mathbf{A}_n \cdots \mathbf{A}_2 \cdot \mathbf{A}_1 \cdot\left[\begin{array}{l}
x \\
y \\
1
\end{array}\right]
$$

可以先将 n 个矩阵乘起来以获取一个简单的矩阵来表示复合变换。

### 变换的分解（Decomposing Complex Transforms）

如何绕着容易一个点旋转？

1. 将旋转中心平移到**原点（origin）**；
2. 旋转；
3. 平移回去。

![image-20230228211506439](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228211506439.png)

$$
T(c) \cdot R(\alpha) \cdot T(-c)
$$

## 三维变换（3D Transformations）

用其次坐标表示点和向量：

- 3D point = $\left[\begin{array}{l}x & y & z & 1 \\  \end{array}\right]^{T}$
- 3D vector = $\left[\begin{array}{l}x & y & z &  0 \\  \end{array}\right]^{T}$

一般来说，$\left[\begin{array}{l}x & y & z & 1 \\  \end{array}\right]^{T}(w \neq 0)$ 表示三维空间的点：$\left[\begin{array}{l} \frac{x}{w} & \frac{y}{w} & \frac{z}{w} & 1 \end{array}\right]^{T}$

用 $4 \times 4$ 的矩阵表示仿射变换：
$$
\left[\begin{array}{l}
x^{\prime} \\
y^{\prime} \\
z^{\prime} \\
1
\end{array}\right]=\left[\begin{array}{lllc}
a & b & c & t_x \\
d & e & f & t_y \\
g & h & i & t_z \\
0 & 0 & 0 & 1
\end{array}\right]  \left[\begin{array}{l}
x \\
y \\
z \\
1
\end{array}\right]
$$

### 伸缩变换

$$
S\left(s_x, s_y, s_z\right)=\left[\begin{array}{cccc}
s_x & 0 & 0 & 0 \\
0 & s_y & 0 & 0 \\
0 & 0 & s_z & 0 \\
0 & 0 & 0 & 1
\end{array}\right]
$$

### 平移

$$
T \left(t_x, t_y, t_z\right)=\left[\begin{array}{cccc}
1 & 0 & 0 & t_x \\
0 & 1 & 0 & t_y \\
0 & 0 & 1 & t_z \\
0 & 0 & 0 & 1
\end{array}\right]
$$

### 旋转

考虑绕着 $x, y, z$ CCW 旋转。

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228212533203.png" alt="image-20230228212533203" style="zoom: 50%;" />

$$
\begin{aligned}
& {R}_x(\alpha)=\left[\begin{array}{cccc}
1 & 0 & 0 & 0 \\
0 & \cos \alpha & -\sin \alpha & 0 \\
0 & \sin \alpha & \cos \alpha & 0 \\
0 & 0 & 0 & 1
\end{array}\right] \\
& R_y(\alpha)=\left[\begin{array}{cccc}
\cos \alpha & 0 & \sin \alpha & 0 \\
0 & 1 & 0 & 0 \\
-\sin \alpha & 0 & \cos \alpha & 0 \\
0 & 0 & 0 & 1
\end{array}\right] \\
& R_z(\alpha)=\left[\begin{array}{cccc}
\cos \alpha & -\sin \alpha & 0 & 0 \\
\sin \alpha & \cos \alpha & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{array}\right]
\end{aligned}
$$

#### 从 $R_x,R_y, R_z$ 复合任意的三维旋转变换（Compose Any 3D Rotation From $R_x,R_y, R_z$）

$$
R_{x y z}(\alpha, \beta, \gamma)=R_x(\alpha) R_y(\beta) R_z(\gamma)
$$

称 $\alpha, \beta, \gamma$ 为欧拉角。

#### Rodrigues’ Rotation Formula

绕着任意轴（$\vec{n}$）旋转角度 $\alpha$.
$$
R(\mathbf{n}, \alpha)=\cos \alpha \cdot \mathbf{I}+ (1-\cos \alpha) \mathbf{n} \mathbf{n}^T+\sin \alpha \cdot\left[\begin{array}{ccc}
0 & -n_z & n_y \\
n_z & 0 & -n_x \\
-n_y & n_x & 0
\end{array}\right]
$$

## 视图变换（Viewing Transformation）

### 视图变换（View / Camera Transformation）

- model transformation
- view transformation
- projection transformation

**定义相机（Define the camera）**

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228222857436.png" alt="image-20230228222857436" style="zoom: 67%;" />

- 位置（Positio）： $\vec{e}$.
- 注视方向（Look-at / gaze direction）：$\hat{g}$.
- 向上的方向（Up direction）：$\hat{t}$.

如果相机和物体一起移动，得到的「照片」是一样的。

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228223134416.png" alt="image-20230228223134416" style="zoom: 67%;" />

我们常常将相机变换到：

- 原点，$\vec{t}$ 指向 Y 正向，$\vec{g}$ 指向 Z 负向。
- 将其他物体随着相机一起变换。

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228223222670.png" alt="image-20230228223222670" style="zoom:67%;" />

使通过 $M_{view}$ 来变换相机。

$M_{view}$ 的数学定义：

- 将 $\vec{e}$ 平移到原点。
- 将 $\vec{g}$ 旋转到 -Z.
- 将 $\vec{t}$ 选择到 Y.
- 将 $\vec{g} \times \vec{t}$ 旋转到 X.

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230228223635703.png" alt="image-20230228223635703" style="zoom:50%;" />

令 $M_{view} = R_{view}T_{view}$.

将 $\vec{e}$ 平移到原点：
$$
T_{ view }=\left[\begin{array}{cccc}
1 & 0 & 0 & -x_e \\
0 & 1 & 0 & -y_e \\
0 & 0 & 1 & -z_e \\
0 & 0 & 0 & 1
\end{array}\right]
$$

将 $\vec{g}$ 旋转到 -Z，$\vec{t}$ 旋转到 Y，$(\vec{g} \times \vec{t})$ 转到 X. 

直接求 $R_{view}$ 比较难，可以考虑其逆变换：X 转到 $(\vec{g} \times \vec{t})$，Y 转到 $\vec{t}$，Z 转到 $-\vec{g}$.
$$
R_{view }^{-1}=\left[\begin{array}{cccc}
x_{\hat{g} \times \hat{t}} & x_t & x_{-g} & 0 \\
y_{\hat{g} \times \hat{t}} & y_t & y_{-g} & 0 \\
z_{\hat{g} \times \hat{t}} & z_t & z_{-g} & 0 \\
0 & 0 & 0 & 1
\end{array}\right] \Leftrightarrow R_{view }=\left[\begin{array}{cccc}
x_{\hat{g} \times \hat{t}} & y_{\hat{g} \times \hat{t}} & z_{\hat{g} \times \hat{t}} & 0 \\
x_t & y_t & z_t & 0 \\
x_{-g} & y_{-g} & z_{-g} & 0 \\
0 & 0 & 0 & 1
\end{array}\right]
$$

> 模型视图是为投影变换做准备。

### 投影变换（Projection Transformation）

计算机图形学中的投影变换：

- 三维到二维（3D to 2D）。
- 分为**正交投影（Orthographic Projection）**和**透视投影（Perspective Projection）**。

![image-20230301084855250](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230301084855250.png)

透视投影 vs 正交投影。

<a href="https://stackoverflow.com/questions/36573283/from-perspective-picture-to-orthographic-picture"><img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/q1SNB.png" alt="q1SNB" /></a>

#### 正交投影（Orthographic Projection）

一种简单的理解方式：

- 将相机的位置置于原点，看向 -Z，向上方向指向 Y。

- Camera located at origin, looking at -Z, up at Y.
- Drop Z coordinate.
- Translate and scale the resulting rectangle to $[-1,1]^2$.

![image-20230301085701599](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230301085701599.png)

In general:

- We want to map a cuboid [l, r] x [b, t] x [f, n] to the canonical (正则、规范、标准) cube $[-1, 1]^{3}$.

![image-20230301085806312](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230301085806312.png)

Translate (center to origin) first, then scale (length / width / height to 2).

Transformation matrix: 

$$
M_{\text {ortho }}=\left[\begin{array}{cccc}
\frac{2}{r-l} & 0 & 0 & 0 \\
0 & \frac{2}{t-b} & 0 & 0 \\
0 & 0 & \frac{2}{n-f} & 0 \\
0 & 0 & 0 & 1
\end{array}\right]\left[\begin{array}{cccc}
1 & 0 & 0 & -\frac{r+l}{2} \\
0 & 1 & 0 & -\frac{t+b}{2} \\
0 & 0 & 1 & -\frac{n+f}{2} \\
0 & 0 & 0 & 1
\end{array}\right]
$$
Caveat:

- Looking at / along -Z is making near and far not intu itive (n > f).
- FYI: that’s why OpenGL (a Graphics API) uses left hand coords.

#### Perspective Projection

- Most common in Computer Graphics, art, visual system.
- Further objects are smaller.
- Parallel lines not parallel; converge to single point.

<img src="https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230301090140176.png" alt="image-20230301090140176" style="zoom:67%;" />

How to do perspective projection:

- First "squish" the frustum into a cuboid ($n \rightarrow n, f \rightarrow f$). ($(M_{persp} \rightarrow M_{ortho}$).

- Do orthographic projection ($M_{ortho}$).

![image-20230301090712104](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230301090712104.png)

Find the relationship between transformed points $(x^{\prime}, y^{\prime}, z^{\prime})$ and the original points $(x,y,z)$.

![image-20230301090756316](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/8919/image-20230301090756316.png)

$$
y^{\prime}=\frac{n}{z} y \quad x^{\prime}=\frac{n}{z} x
$$
In homogeneous coordinates:
$$
\left[\begin{array}{c}
x \\
y \\
z \\
1
\end{array}\right] \Rightarrow\left[\begin{array}{c}
n x / z \\
n y / z \\
\text { unknown } \\
1
\end{array}\right] \stackrel{\times z}{=}\left[\begin{array}{c}
n x \\
n y \\
\text { unknown } \\
z
\end{array}\right]
$$
So the "squish" (persp to ortho) projection does this:
$$
M_{\text {persp } \rightarrow \text { ortho }}^{(4 \times 4)}\left[\begin{array}{l}
x \\
y \\
z \\
1
\end{array}\right]=\left[\begin{array}{c}
n x \\
n y \\
\text { unknown } \\
z
\end{array}\right]
$$
Already good enough to figure out part of $M_{persp->ortho}$.

Observation: the third row is responsible for $z^{\prime}$.

- Any point on the near plane will not change.

- Any point’s z on the far plane will not change.

$$
M_{\text {persp } \rightarrow \text { ortho }}^{(4 \times 4)}\left[\begin{array}{l}
x \\
y \\
z \\
1
\end{array}\right]=\left[\begin{array}{c}
n x \\
n y \\
\text { unknown } \\
z
\end{array}\right] \stackrel{\text { replace with } \mathrm{n}}{\Longrightarrow}\left[\begin{array}{l}
x \\
y \\
n \\
1
\end{array}\right] \Rightarrow\left[\begin{array}{l}
x \\
y \\
n \\
1
\end{array}\right]=\left[\begin{array}{l}
n x \\
n y \\
n^2 \\
n
\end{array}\right]
$$



So the third row must be of the form $\left[\begin{array}{llll}0 & 0 & A & B \end{array}\right]$:
$$
\left[\begin{array}{llll}
0 & 0 & A & B
\end{array}\right]\left[\begin{array}{l}
x \\
y \\
n \\
1
\end{array}\right]=n^2 \Longrightarrow  A n+B=n^2
$$
Any point’s z on the far plane will not change:
$$
\left[\begin{array}{l}
0 \\
0 \\
f \\
1
\end{array}\right] \Rightarrow\left[\begin{array}{l}
0 \\
0 \\
f \\
1
\end{array}\right]==\left[\begin{array}{c}
0 \\
0 \\
f^2 \\
f
\end{array}\right] \Longrightarrow A f+B=f^2
$$
Solve for A and B:
$$
\begin{aligned}
& A n+B=n^2 \\
& A f+B=f^2
\end{aligned} \Longrightarrow \begin{aligned}
& A=n+f \\
& B=-n f
\end{aligned}
$$
Finally, every entry in $M_{persp \rightarrow ortho}$ is known:
$$
\left[\begin{array}{cccc}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & n + f & -nf \\
0 & 0 & 1 & 0
\end{array}\right]
$$


What’s next?

- Do orthographic projection ($M_{ortho}$) to finish.

- $M_{persp} = M_{ortho}M_{persp \rightarrow ortho}$